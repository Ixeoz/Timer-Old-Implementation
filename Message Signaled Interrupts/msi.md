# **Message Signaled Interrupts**.

## **¿Qué es?**

Las interrupciones señaladas por mensaje **(MSI)** sin un método alternativo de señalización de interrupción en banda, utilizando mensajes especiales en banda para reemplazar la afirmación tradicional fuera de banda de líneas de interrupción dedicadas. Esto fue introducido en la especificación **PCI 2.2** como una alternativa a las interrupciones basadas en línea. En lugar de usar un pin dedicado para desencadenar interrupciones, los dispositivos que usan **MSI** desencadenan una interrupción escribiendo un valor en la dirección de memoria determinada. Esto causa una interrupción y Windows llama al [ISR](https://learn.microsoft.com/es-es/windows-hardware/drivers/kernel/introduction-to-interrupt-service-routines) (Rutinas de Servicio de Interrupción) con el contenido del mensaje y la dirección donde se entregó el mensaje. Un dispositivo también puede entregar múltiples mensajes **(hasta 32)** a la dirección de memoria, entregando cargas útiles diferentes según el evento.

La comunicación se basa en un valor de memoria y, dado que el contenido se entrega con interrupción, se elimina la necesidad de líneas [IRQ](https://blog.redigit.es/irq-interrupciones-de-hardware-definicion-y-significado/) (haciendo que el límite total del sistema de **MSI** sea igual al número de vectores de interrupción, no líneas **IRQ**), así como la necesidad de que un **ISR** del controlador consulte al dispositivo para obtener datos relacionados con la interrupción, disminuyendo la latencia. Debido al gran número de interrupciones de dispositivos disponibles a través de este modelo, esto anula efectivamente cualquier beneficio de compartir interrupciones, disminuyendo aún más la latencia al entregar directamente los datos de interrupción al **ISR**.

Por otro lado, está representado **MSI-X** que es una extensión del modelo **MSI** introducida en **PCI 3.0** que agrega soporte para mensajes de **32 bits**, un máximo de **2048** mensajes diferentes y la capacidad de usar una dirección diferente para cada una de las cargas útiles de **MSI**. Los dispositivos que admiten **MSI-X PCI 3.0** cuentan con una tabla de hardware programable dinámicamente que contiene entradas para cada una de las fuentes de interrupción en el dispositivo. Cada entrada en esta tabla puede programarse con uno de los mensajes asignados a un dispositivo y puede enmascararse de forma independiente. Los controladores pueden cambiar la programación de un mensaje de interrupción en una entrada de tabla y si una entrada ha sido enmascarada.

No tiene sentido ponerlo todo en **HIGH** (podría dejarse en **UNDEFINED**), ya que te puede perjudicar ese programa está hecho para el **IRQ** es que los que están con números positivos son interrupciones basadas en línea. Los que dispositivos que están con número negativo para **IRQ** están en modo de interrupciones en señales de mensajes. El problema es que si se comparten las interrupciones eso puede causar problemas grandes de estabilidad. Ejemplo, que consuma seis líneas de **IRQ** para un solo dispositivo hace que se agote la línea. Por otro lado, el problema de **IRQ** en líneas incorrectas causa interrupciones o bloqueos en el sistema, ya que puede tener altibajos en el **ISR** hasta que se reconoce. Y pues, las que están basadas en línea en algunos casos tienen una estabilidad muy deficiente en el marco multiprocesador. Luego, se introdujo un nuevo estándar **MSI** (Interrupciones señalizadas por mensaje), su función es que envía un mensaje al controlador y escribe una dirección de memoria muy específica, esto genera una interrupción que Windows conduce el **ISR** a un contenido de mensaje y dirección dónde se entrega. En el sentido de; si el Mensaje usa múltiples **IRQ** y funciona mal, se puede establecer un límite y verificar que esto funcione correctamente.

# **Relación con las líneas IRQ**.

El uso compartido de líneas **IRQ** puede tener un impacto en el rendimiento de una PC si dos o más dispositivos que comparten el mismo número de **IRQ** tienen altas tasas de interrupción. Esto puede aumentar la sobrecarga de procesamiento de interrupciones y afecta el rendimiento del sistema. Las interrupciones señaladas por mensaje **(MSI)** ayudan a reducir los conflictos de uso compartido de **IRQs**. A diferencia de las interrupciones basadas en líneas, que utilizan un pin dedicado para activar interrupciones y pueden tener un número limitado de **IRQ** disponibles, las interrupciones señalados por mensajes se activan escribiendo un valor en una dirección de memoria específica. Esto permite que cada dispositivo tenga su propia dirección de memoria para enviar interrupciones, lo que reduce la posibilidad de conflictos de uso compartido de **IRQ**. Además, el conflicto de **IRQ Sharing** puede causar problemas de estabilidad, incluyendo [BSODs](https://es.wikipedia.org/wiki/Pantalla_azul_de_la_muerte).

## **Referencias:**

- [Windows Internals Part 1 6th Edition](https://repo.zenk-security.com/Linux%20et%20systemes%20d.exploitations/Windows%20Internals%20Part%201_6th%20Edition.pdf).

- [Introducción a Message-Signaled interrupciones](https://learn.microsoft.com/es-es/windows-hardware/drivers/kernel/introduction-to-message-signaled-interrupts).

- [Introducción a las rutinas de servicio de interrupción](https://learn.microsoft.com/es-es/windows-hardware/drivers/kernel/introduction-to-interrupt-service-routines).